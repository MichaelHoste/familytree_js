// Generated by CoffeeScript 1.6.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.Constants = (function() {
    function Constants() {}

    Constants.width = 90;

    Constants.height = 50;

    Constants.padding = 20;

    Constants.margin = 60;

    Constants.fontSize = 15;

    Constants.lineWidth = 2;

    Constants.verticalMargin = Constants.margin * 1.5;

    Constants.t = function(enText, frText) {
      if (Constants.locale === void 0 || Constants.locale === 'en') {
        return enText;
      } else {
        return frText;
      }
    };

    return Constants;

  })();

  this.FamilyTree = (function() {
    function FamilyTree(options) {
      var _this = this;
      if (options == null) {
        options = {};
      }
      this.animate = __bind(this.animate, this);
      this.options = options;
      this.width = options.width;
      this.height = options.height;
      this.people = options.people || [];
      this.root = options.root;
      this.stage = new PIXI.Container();
      this.t = Constants.t;
      this.onCreate = function(person) {
        if (options.onCreate) {
          return options.onCreate(person, _this.serialize());
        }
      };
      this.onEdit = function(person) {
        if (options.onEdit) {
          return options.onEdit(person, _this.serialize());
        }
      };
      this.onDelete = function(person) {
        if (options.onDelete) {
          return options.onDelete(person, _this.serialize());
        }
      };
      if (options.serializedData) {
        this.deserialize(options.serializedData);
      }
      if ($('#family-tree').length) {
        this.initializeRenderer();
        this.refreshStage();
        this.refreshMenu();
        this.bindMenu();
        this.animate();
      }
    }

    FamilyTree.prototype.initializeRenderer = function() {
      this.renderer = new PIXI.autoDetectRenderer(this.width, this.height, {
        antialias: true,
        backgroundColor: 0xFFFFFF
      });
      return $('#family-tree')[0].appendChild(this.renderer.view);
    };

    FamilyTree.prototype.initializeBackground = function() {
      this.background = PIXI.Sprite.fromImage('images/pixel.gif');
      this.background.width = this.width;
      this.background.height = this.height;
      this.stage.familyTree = this;
      this.stage.background = this.background;
      return this.stage.addChild(this.background);
    };

    FamilyTree.prototype.bindScroll = function() {
      var onDown, onMove, onUp,
        _this = this;
      this.background.interactive = true;
      onDown = function(mouseData) {
        _this.isDown = true;
        _this.startX = _this.x;
        _this.startY = _this.y;
        _this.startOffsetX = mouseData.data.global.x;
        return _this.startOffsetY = mouseData.data.global.y;
      };
      onUp = function(mouseData) {
        return _this.isDown = false;
      };
      onMove = function(mouseData) {
        if (_this.isDown) {
          _this.x = _this.startX + mouseData.data.global.x - _this.startOffsetX;
          _this.y = _this.startY + mouseData.data.global.y - _this.startOffsetY;
          return _this.animate();
        }
      };
      this.background.on('mousedown', onDown);
      this.background.on('touchstart', onDown);
      this.background.on('mouseup', onUp);
      this.background.on('touchend', onUp);
      this.background.on('mousemove', onMove);
      return this.background.on('touchmove', onMove);
    };

    FamilyTree.prototype.bindMenu = function() {
      var createFirstPerson,
        _this = this;
      createFirstPerson = function(name, sex) {
        _this.root = new Person(name, sex);
        _this.people.push(_this.root);
        _this.onCreate(_this.root);
        _this.refreshStage();
        return _this.refreshMenu();
      };
      $('#family-tree-panel').on('click', 'button[data-action="add-man"]', function() {
        var name;
        name = prompt(_this.t("What's the first man's name?", "Quel est le nom du premier homme ?"), _this.t("Me", "Moi"));
        if (name) {
          return createFirstPerson(name, 'M');
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-woman"]', function() {
        var name;
        name = prompt(_this.t("What's the first man's name?", "Quel est le nom de la première femme ?"), _this.t("Me", "Moi"));
        if (name) {
          return createFirstPerson(name, 'F');
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-partner"]', function() {
        var name, partner, suggestion;
        if (_this.root.sex === 'M') {
          suggestion = _this.t("Wife of " + _this.root.name, "Femme de " + _this.root.name);
        } else if (_this.root.sex === 'F') {
          suggestion = _this.t("Husband of " + _this.root.name, "Mari de " + _this.root.name);
        }
        name = prompt(_this.t("What's the partner's name?", "Quel est le nom du partenaire ?"), suggestion);
        if (name) {
          _this.cleanTree();
          partner = _this.root.addPartner(name);
          _this.people.push(partner);
          _this.onCreate(partner);
          _this.refreshStage();
          return _this.refreshMenu();
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-parents"]', function() {
        var fatherName, fatherSuggestion, motherName, motherSuggestion, parents;
        fatherSuggestion = _this.t("Father of " + _this.root.name, "Père de " + _this.root.name);
        fatherName = prompt(_this.t("What's the father's name?", "Quel est le nom du père ?"), fatherSuggestion);
        if (fatherName) {
          motherSuggestion = _this.t("Mother of " + _this.root.name, "Mère de " + _this.root.name);
          motherName = prompt(_this.t("What's the mother's name?", "Quel est le nom de la mère ?"), motherSuggestion);
          if (fatherName && motherName) {
            _this.cleanTree();
            parents = _this.root.addParents(fatherName, motherName);
            _this.people.push(parents[0]);
            _this.onCreate(parents[0]);
            _this.people.push(parents[1]);
            _this.onCreate(parents[1]);
            _this.refreshStage();
            return _this.refreshMenu();
          }
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-brother"]', function() {
        var brother, name, suggestion;
        suggestion = _this.t("Brother of " + _this.root.name, "Frère de " + _this.root.name);
        name = prompt(_this.t("What's the brother's name?", "Quel est le nom du frère ?"), suggestion);
        if (name) {
          _this.cleanTree();
          brother = _this.root.addBrother(name);
          _this.people.push(brother);
          _this.onCreate(brother);
          _this.refreshStage();
          return _this.refreshMenu();
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-sister"]', function() {
        var name, sister, suggestion;
        suggestion = _this.t("Sister of " + _this.root.name, "Soeur de " + _this.root.name);
        name = prompt(_this.t("What's the sister's name?", "Quel est le nom de la soeur ?"), suggestion);
        if (name) {
          _this.cleanTree();
          sister = _this.root.addSister(name);
          _this.people.push(sister);
          _this.onCreate(sister);
          _this.refreshStage();
          return _this.refreshMenu();
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-son"]', function(event) {
        var name, partner, partnerUuid, son, suggestion;
        suggestion = _this.t("Son of " + _this.root.name, "Fils de " + _this.root.name);
        name = prompt(_this.t("What's the son's name?", "Quel est le nom du fils ?"), suggestion);
        if (name) {
          _this.cleanTree();
          partnerUuid = $(event.target).data('with');
          partner = _.findWhere(_this.people, {
            uuid: partnerUuid
          });
          son = _this.root.relationWith(partner).addChild(name, 'M');
          _this.people.push(son);
          _this.onCreate(son);
          _this.refreshStage();
          return _this.refreshMenu();
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="add-daughter"]', function(event) {
        var daughter, name, partner, partnerUuid, suggestion;
        suggestion = _this.t("Daughter of " + _this.root.name, "Fille de " + _this.root.name);
        name = prompt(_this.t("What's the daughter's name?", "Quel est le nom de la fille ?"), suggestion);
        if (name) {
          _this.cleanTree();
          partnerUuid = $(event.target).data('with');
          partner = _.findWhere(_this.people, {
            uuid: partnerUuid
          });
          daughter = _this.root.relationWith(partner).addChild(name, 'F');
          _this.people.push(daughter);
          _this.onCreate(daughter);
          _this.refreshStage();
          return _this.refreshMenu();
        }
      });
      $('#family-tree-panel').on('click', 'button[data-action="edit"]', function(event) {
        return _this.onEdit(_this.root);
      });
      return $('#family-tree-panel').on('click', 'button[data-action="remove"]', function(event) {
        var partnerRelation, _i, _len, _ref;
        if (confirm(_this.t("Remove " + _this.root.name + "?", "Supprimer " + _this.root.name + " ?"))) {
          _this.cleanTree();
          _this.people = _.without(_this.people, _this.root);
          if (_this.root.parents().length === 0) {
            _ref = _this.root.partnerRelations;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              partnerRelation = _ref[_i];
              if (_this.root.sex === 'F') {
                partnerRelation.husband.partnerRelations = _.without(partnerRelation.husband.partnerRelations, partnerRelation);
              } else if (_this.root.sex === 'M') {
                partnerRelation.wife.partnerRelations = _.without(partnerRelation.wife.partnerRelations, partnerRelation);
              }
            }
          } else if (_this.root.children().length === 0) {
            _this.root.parentRelation.children = _.without(_this.root.parentRelation.children, _this.root);
          }
          _this.onDelete(_this.root);
          if (_this.people.length) {
            if (_this.root.parentRelation) {
              _this.root = _this.root.father();
            } else {
              if (_this.root.sex === 'M') {
                _this.root = _this.root.partnerRelations[0].wife;
              } else if (_this.root.sex === 'F') {
                _this.root = _this.root.partnerRelations[0].husband;
              }
            }
          }
          _this.refreshStage();
          return _this.refreshMenu();
        }
      });
    };

    FamilyTree.prototype.relations = function() {
      var partnerRelation, person, relations, _i, _j, _len, _len1, _ref, _ref1;
      relations = [];
      _ref = this.people;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        person = _ref[_i];
        _ref1 = person.partnerRelations;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          partnerRelation = _ref1[_j];
          relations.push(partnerRelation);
        }
      }
      return _.uniq(relations, function(relation) {
        return relation.uuid;
      });
    };

    FamilyTree.prototype.initializeNodesAndRelations = function() {
      var node, person, relation, _i, _j, _len, _len1, _ref, _ref1, _results;
      _ref = this.relations();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        relation = _ref[_i];
        if (relation.node === void 0) {
          new RelationNode(this.stage, relation);
        } else {
          relation.node.initializeLines();
        }
      }
      _ref1 = this.people;
      _results = [];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        person = _ref1[_j];
        node = new PersonNode(this.stage, person);
        if (person.uuid === this.root.uuid) {
          this.root = person;
          _results.push(this.rootNode = node);
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    FamilyTree.prototype.refreshStage = function() {
      var num, _i, _results;
      while (this.stage.children.length > 0) {
        this.stage.removeChild(this.stage.children[0]);
      }
      this.initializeBackground();
      this.bindScroll();
      this.initializeNodesAndRelations();
      _results = [];
      for (num = _i = 0; _i <= 10; num = ++_i) {
        _results.push(this.animate());
      }
      return _results;
    };

    FamilyTree.prototype.refreshMenu = function() {
      var daughterCaption, partner, sonCaption, _i, _len, _ref;
      $("#family-tree-panel div").empty();
      if (this.people.length === 0) {
        $('#family-tree-panel div').append('<button type="button" class="btn btn-default" data-action="add-man">' + this.t("Add Man", "Ajouter un homme") + '</button>');
        return $('#family-tree-panel div').append('<button type="button" class="btn btn-default" data-action="add-woman">' + this.t("Add Woman", "Ajouter une femme") + '</button>');
      } else {
        if (!this.root.partnerRelations.length) {
          $('#family-tree-panel div').append('<button type="button" class="btn btn-default" data-action="add-partner">' + this.t("Add Partner", "Ajouter un partenaire") + '</button>');
        }
        if (this.root.parentRelation) {
          $('#family-tree-panel div').append('<button type="button" class="btn btn-default" data-action="add-brother">' + this.t("Add Brother", "Ajouter un frère") + '</button>');
          $('#family-tree-panel div').append('<button type="button" class="btn btn-default" data-action="add-sister">' + this.t("Add Sister", "Ajouter une soeur") + '</button>');
        }
        if (!this.root.parentRelation) {
          $('#family-tree-panel div').append('<button type="button" class="btn btn-default" data-action="add-parents">' + this.t("Add Parents", "Ajouter les parents") + '</button>');
        }
        _ref = this.root.partners();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          partner = _ref[_i];
          sonCaption = this.t("Add son with " + partner.name, "Ajouter un fils avec " + partner.name);
          daughterCaption = this.t("Add daughter with " + partner.name, "Aouter une fille avec " + partner.name);
          $('#family-tree-panel div').append("<button type=\"button\" class=\"btn btn-default\" data-action=\"add-son\"      data-with=\"" + partner.uuid + "\">" + sonCaption + "</button>");
          $('#family-tree-panel div').append("<button type=\"button\" class=\"btn btn-default\" data-action=\"add-daughter\" data-with=\"" + partner.uuid + "\">" + daughterCaption + "</button>");
        }
        if (this.options.onEdit) {
          $('#family-tree-panel div').append("<button type=\"button\" class=\"btn btn-default\" data-action=\"edit\">" + this.t("Edit", "Modifier") + "</button>");
        }
        if (!this.root.partnerRelations.length || this.root.children().length === 0) {
          return $('#family-tree-panel div').append("<button type=\"button\" class=\"btn btn-default\" data-action=\"remove\">" + this.t("Delete", "Supprimer") + "</button>");
        }
      }
    };

    FamilyTree.prototype.cleanTree = function() {
      var partnerRelation, person, _i, _len, _ref, _results;
      _ref = this.people;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        person = _ref[_i];
        person.node.hideRectangle();
        person.node.hideVLines();
        _results.push((function() {
          var _j, _len1, _ref1, _results1;
          _ref1 = person.partnerRelations;
          _results1 = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            partnerRelation = _ref1[_j];
            _results1.push(partnerRelation.node.hideLines());
          }
          return _results1;
        })());
      }
      return _results;
    };

    FamilyTree.prototype.serialize = function() {
      var partnerRelation, people, person, relations, serialization, _i, _j, _len, _len1, _ref, _ref1;
      people = [];
      relations = [];
      _ref = this.people;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        person = _ref[_i];
        people.push({
          uuid: person.uuid,
          name: person.name,
          sex: person.sex
        });
        _ref1 = person.partnerRelations;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          partnerRelation = _ref1[_j];
          relations.push({
            uuid: partnerRelation.uuid,
            children: _.map(partnerRelation.children, function(child) {
              return child.uuid;
            }),
            husband: partnerRelation.husband.uuid,
            wife: partnerRelation.wife.uuid
          });
        }
      }
      return serialization = {
        people: people,
        relations: _.uniq(relations, function(relation) {
          return relation.uuid;
        }),
        root: this.root.uuid
      };
    };

    FamilyTree.prototype.deserialize = function(serialization) {
      var child, husband, person, relation, sC, sP, sR, serializedPeople, serializedRelations, serializedRoot, wife, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1;
      _ref = this.stage.children;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        this.stage.removeChild(child);
      }
      serializedPeople = serialization.people;
      serializedRelations = serialization.relations;
      serializedRoot = serialization.root;
      this.people = [];
      for (_j = 0, _len1 = serializedPeople.length; _j < _len1; _j++) {
        sP = serializedPeople[_j];
        person = new Person(sP.name, sP.sex, sP.uuid);
        this.people.push(person);
      }
      for (_k = 0, _len2 = serializedRelations.length; _k < _len2; _k++) {
        sR = serializedRelations[_k];
        relation = new Relation(sR.uuid);
        husband = _.findWhere(this.people, {
          uuid: sR.husband
        });
        relation.husband = husband;
        husband.partnerRelations.push(relation);
        wife = _.findWhere(this.people, {
          uuid: sR.wife
        });
        relation.wife = wife;
        wife.partnerRelations.push(relation);
        _ref1 = sR.children;
        for (_l = 0, _len3 = _ref1.length; _l < _len3; _l++) {
          sC = _ref1[_l];
          child = _.findWhere(this.people, {
            uuid: sC
          });
          child.parentRelation = relation;
          relation.children.push(child);
        }
      }
      this.root = _.findWhere(this.people, {
        uuid: serializedRoot
      });
      if (this.renderer) {
        return this.refreshStage();
      }
    };

    FamilyTree.prototype.loadData = function(data) {
      return this.deserialize(serializedData);
    };

    FamilyTree.prototype.animate = function() {
      if (this.x === void 0) {
        this.x = this.width / 2;
      }
      if (this.y === void 0) {
        this.y = this.height / 2;
      }
      if (this.rootNode) {
        this.rootNode.displayTree(this.x, this.y);
      }
      return this.renderer.render(this.stage);
    };

    return FamilyTree;

  })();

  this.Person = (function() {
    function Person(name, sex, uuid) {
      if (uuid == null) {
        uuid = void 0;
      }
      this.name = name;
      this.sex = sex;
      this.parentRelation = void 0;
      this.partnerRelations = [];
      this.uuid = uuid ? uuid : window.uuid();
    }

    Person.prototype.partners = function() {
      var _this = this;
      return _.collect(this.partnerRelations, function(relation) {
        return relation[_this.sex === 'M' ? 'wife' : 'husband'];
      });
    };

    Person.prototype.children = function() {
      return _.flatten(_.collect(this.partnerRelations, function(partnerRelation) {
        return partnerRelation.children;
      }));
    };

    Person.prototype.mother = function() {
      if (this.parentRelation) {
        return this.parentRelation.wife;
      }
    };

    Person.prototype.father = function() {
      if (this.parentRelation) {
        return this.parentRelation.husband;
      }
    };

    Person.prototype.parents = function() {
      return _.compact([this.father(), this.mother()]);
    };

    Person.prototype.grandparents = function() {
      return this.father().parents().concat(this.mother().parents());
    };

    Person.prototype.ancestors = function() {
      var parents;
      parents = this.parents();
      if (_.isEmpty(parents)) {
        return [];
      } else {
        return parents.concat(this.father().ancestors()).concat(this.mother().ancestors());
      }
    };

    Person.prototype.descendants = function() {
      var children;
      children = this.children();
      if (_.isEmpty(children)) {
        return [];
      } else {
        return children.concat(_.compact(_.flatten(_.map(children, function(child) {
          return child.descendants();
        }))));
      }
    };

    Person.prototype.siblings = function() {
      if (this.parentRelation) {
        return _.difference(this.parentRelation.children, [this]);
      } else {
        return [];
      }
    };

    Person.prototype.niblings = function() {
      return _.flatten(_.collect(this.siblings(), function(sibling) {
        return sibling.children();
      }));
    };

    Person.prototype.parentsSiblings = function() {
      return this.father().siblings().concat(this.mother().siblings());
    };

    Person.prototype.cousins = function() {
      return _.flatten(_.collect(this.parentsSiblings(), function(sibling) {
        return sibling.children();
      }));
    };

    Person.prototype.bloodRelatives = function() {
      return _.uniq(_.flatten(_.map(this.ancestors(), function(ancestor) {
        return ancestor.descendants().concat([ancestor]);
      })));
    };

    Person.prototype.isBloodRelativeOf = function(otherPerson) {
      return _.includes(this.bloodRelatives(), otherPerson);
    };

    Person.prototype.relationWith = function(person) {
      var _this = this;
      return _.find(this.partnerRelations, function(relation) {
        return (_this.sex === 'M' && relation.wife === person) || (_this.sex === 'F' && relation.husband === person);
      });
    };

    Person.prototype.addParents = function(fatherName, motherName) {
      if (fatherName == null) {
        fatherName = void 0;
      }
      if (motherName == null) {
        motherName = void 0;
      }
      fatherName = fatherName ? fatherName : Constants.t("Father of " + this.name, "Père de " + this.name);
      motherName = motherName ? motherName : Constants.t("Mother of " + this.name, "Mère de " + this.name);
      this.parentRelation = new Relation();
      this.parentRelation.children.push(this);
      this.parentRelation.husband = new Person(fatherName, 'M');
      this.parentRelation.wife = new Person(motherName, 'F');
      this.parentRelation.husband.partnerRelations.push(this.parentRelation);
      this.parentRelation.wife.partnerRelations.push(this.parentRelation);
      return [this.parentRelation.husband, this.parentRelation.wife];
    };

    Person.prototype.addBrother = function(name) {
      if (name == null) {
        name = void 0;
      }
      name = name ? name : Constants.t("Brother of " + this.name, "Fère de " + this.name);
      if (this.parentRelation) {
        return this.parentRelation.addChild(name, 'M');
      } else {
        return void 0;
      }
    };

    Person.prototype.addSister = function(name) {
      if (name == null) {
        name = void 0;
      }
      name = name ? name : Constants.t("Sister of " + this.name, "Soeur de " + this.name);
      if (this.parentRelation) {
        return this.parentRelation.addChild(name, 'F');
      } else {
        return void 0;
      }
    };

    Person.prototype.addPartner = function(name) {
      var husbandName, relation, wifeName;
      if (name == null) {
        name = void 0;
      }
      relation = new Relation();
      if (this.sex === 'M') {
        relation.husband = this;
        wifeName = name ? name : Constants.t("Wife of " + this.name, "Femme de " + this.name);
        relation.wife = new Person(wifeName, 'F');
        relation.wife.partnerRelations.push(relation);
        this.partnerRelations.push(relation);
        return relation.wife;
      } else {
        relation.wife = this;
        husbandName = name ? name : Constants.t("Husband of " + this.name, "Mari du " + this.name);
        relation.husband = new Person(husbandName, 'M');
        relation.husband.partnerRelations.push(relation);
        this.partnerRelations.push(relation);
        return relation.husband;
      }
    };

    return Person;

  })();

  this.PersonNode = (function() {
    function PersonNode(stage, person) {
      this.stage = stage;
      this.person = person;
      this.root = false;
      this.x = 0;
      this.y = 0;
      this.person.node = this;
      this.initializeVLine();
      this.initializeSmallVLine();
      this.initializeRectangle();
      this.initializeText();
      this.bindRectangle();
    }

    PersonNode.prototype.initializeRectangle = function() {
      this.graphics = new PIXI.Graphics();
      this.drawGraphics();
      return this.stage.addChild(this.graphics);
    };

    PersonNode.prototype.initializeText = function() {
      this.text = new PIXI.Text(this.person.name, {
        font: "" + Constants.fontSize + "px Arial",
        fill: 0x222222,
        align: 'center',
        wordWrap: true,
        wordWrapWidth: Constants.width - Constants.padding / 2
      });
      this.text.anchor.x = 0.5;
      this.text.anchor.y = 0.5;
      return this.stage.addChild(this.text);
    };

    PersonNode.prototype.initializeVLine = function() {
      if (this.person.parentRelation) {
        this.vLine = new PIXI.Graphics();
        this.vLine.lineStyle(Constants.lineWidth, 0x333333, 1);
        this.vLine.moveTo(0, 0);
        this.vLine.lineTo(0, -Constants.verticalMargin / 2);
        this.stage.addChild(this.vLine);
        return this.hideVLines();
      }
    };

    PersonNode.prototype.initializeSmallVLine = function() {
      if (this.person.parentRelation) {
        this.smallVLine = new PIXI.Graphics();
        this.smallVLine.lineStyle(Constants.lineWidth, 0xC0C0C0, 1);
        this.smallVLine.moveTo(0, 0);
        this.smallVLine.lineTo(0, -Constants.verticalMargin / 4);
        this.stage.addChild(this.smallVLine);
        return this.hideVLines();
      }
    };

    PersonNode.prototype.drawGraphics = function() {
      var color;
      this.graphics.lineStyle(Constants.lineWidth, 0x333333, 1);
      if (this.root) {
        color = 0xF1F1F1;
      } else {
        if (this.person.sex === 'M') {
          color = 0xB4D8E7;
        } else {
          color = 0xFFC0CB;
        }
      }
      this.graphics.beginFill(color);
      if (this.person.sex === 'M') {
        return this.drawRectangle();
      } else {
        return this.drawRoundRectangle();
      }
    };

    PersonNode.prototype.drawRectangle = function() {
      return this.graphics.drawRect(-Constants.width / 2, -Constants.height / 2, Constants.width, Constants.height);
    };

    PersonNode.prototype.drawRoundRectangle = function() {
      return this.graphics.drawRoundedRect(-Constants.width / 2, -Constants.height / 2, Constants.width, Constants.height, Constants.height / 4);
    };

    PersonNode.prototype.bindRectangle = function() {
      var onClick,
        _this = this;
      this.graphics.interactive = true;
      this.graphics.on('mouseover', function() {
        return $('#family-tree').css('cursor', 'pointer');
      });
      this.graphics.on('mouseout', function() {
        return $('#family-tree').css('cursor', 'default');
      });
      this.graphics.on('mousedown', this.stage.background._events.mousedown.fn);
      this.graphics.on('touchstart', this.stage.background._events.touchstart.fn);
      this.graphics.on('mouseup', this.stage.background._events.mouseup.fn);
      this.graphics.on('touchend', this.stage.background._events.touchend.fn);
      onClick = function(mouseData) {
        var familyTree, moveX, moveY;
        familyTree = _this.stage.familyTree;
        moveX = Math.abs(familyTree.startOffsetX - mouseData.data.global.x);
        moveY = Math.abs(familyTree.startOffsetY - mouseData.data.global.y);
        if (moveX + moveY < 15) {
          familyTree.oldRootNode = familyTree.rootNode;
          familyTree.rootNode.root = false;
          familyTree.rootNode = _this;
          familyTree.root = _this.person;
          familyTree.refreshMenu();
          familyTree.cleanTree();
          familyTree.x = familyTree.width / 2;
          familyTree.y = familyTree.height / 2;
          _this.displayTree(familyTree.x, familyTree.y);
          return familyTree.animate();
        }
      };
      this.graphics.on('click', onClick);
      return this.graphics.on('tap', onClick);
    };

    PersonNode.prototype.setPosition = function(x, y, apply) {
      if (apply == null) {
        apply = true;
      }
      this.x = x;
      this.y = y;
      if (apply) {
        this.graphics.position.x = x;
        this.graphics.position.y = y;
        this.text.position.x = x;
        this.text.position.y = y;
        if (this.person.parentRelation) {
          if (this.person.isBloodRelativeOf(this.stage.familyTree.root)) {
            this.vLine.position.x = x;
            return this.vLine.position.y = y - Constants.height / 2;
          } else {
            this.smallVLine.position.x = x;
            return this.smallVLine.position.y = y - Constants.height / 2;
          }
        }
      }
    };

    PersonNode.prototype.leftMostNodeX = function() {
      var partner, partnerType, xArray;
      if (this.person.partnerRelations.length) {
        xArray = _.collect(this.person.partnerRelations[0].children, function(child) {
          return child.node.leftMostNodeX();
        });
        partnerType = this.person.sex === 'M' ? 'wife' : 'husband';
        partner = this.person.partnerRelations[0][partnerType];
        xArray.push(partner.node.x);
      } else {
        xArray = [];
      }
      xArray.push(this.x);
      return _.min(xArray);
    };

    PersonNode.prototype.rightMostNodeX = function() {
      var partner, partnerType, xArray;
      if (this.person.partnerRelations.length) {
        xArray = _.collect(this.person.partnerRelations[0].children, function(child) {
          return child.node.rightMostNodeX();
        });
        partnerType = this.person.sex === 'M' ? 'wife' : 'husband';
        partner = this.person.partnerRelations[0][partnerType];
        xArray.push(partner.node.x);
      } else {
        xArray = [];
      }
      xArray.push(this.x);
      return _.max(xArray);
    };

    PersonNode.prototype.leftMostParentNodeX = function() {
      var father, mother, parent, peopleX, _i, _len, _ref;
      peopleX = [];
      _ref = this.person.parents();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        parent = _ref[_i];
        peopleX.concat(_.collect(parent.siblings(), function(person) {
          return person.node.x;
        }));
      }
      if (this.person.parentRelation) {
        father = this.person.parentRelation.husband;
        mother = this.person.parentRelation.wife;
        if (father) {
          peopleX.push(father.node.x);
        }
        if (mother) {
          peopleX.push(mother.node.x);
        }
        if (father) {
          peopleX.push(father.node.leftMostParentNodeX());
        }
        if (mother) {
          peopleX.push(mother.node.leftMostParentNodeX());
        }
      }
      return _.min(peopleX);
    };

    PersonNode.prototype.rightMostParentNodeX = function() {
      var father, mother, parent, peopleX, _i, _len, _ref;
      peopleX = [];
      _ref = this.person.parents();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        parent = _ref[_i];
        peopleX.concat(_.collect(parent.siblings(), function(person) {
          return person.node.x;
        }));
      }
      if (this.person.parentRelation) {
        father = this.person.parentRelation.husband;
        mother = this.person.parentRelation.wife;
        if (father) {
          peopleX.push(father.node.x);
        }
        if (mother) {
          peopleX.push(mother.node.x);
        }
        if (father) {
          peopleX.push(father.node.rightMostParentNodeX());
        }
        if (mother) {
          peopleX.push(mother.node.rightMostParentNodeX());
        }
      }
      return _.max(peopleX);
    };

    PersonNode.prototype.size = function() {
      return this.rightMostNodeX() - this.leftMostNodeX() + Constants.width;
    };

    PersonNode.prototype.hideRectangle = function() {
      this.graphics.position.x = -1000;
      this.graphics.position.y = -1000;
      this.text.position.x = -1000;
      return this.text.position.y = -1000;
    };

    PersonNode.prototype.hideVLines = function() {
      if (this.vLine) {
        this.vLine.position.x = -1000;
      }
      if (this.vLine) {
        this.vLine.position.y = -1000;
      }
      if (this.smallVLine) {
        this.smallVLine.position.x = -1000;
      }
      if (this.smallVLine) {
        return this.smallVLine.position.y = -1000;
      }
    };

    PersonNode.prototype.displayTree = function(x, y) {
      this.root = true;
      this.graphics.clear();
      this.drawGraphics();
      if (this.stage.familyTree.oldRootNode) {
        this.stage.familyTree.oldRootNode.graphics.clear();
        this.stage.familyTree.oldRootNode.drawGraphics();
      }
      this.setPosition(x, y);
      this.updateBottomPeople();
      return this.updateTopPeople();
    };

    PersonNode.prototype.updateBottomPeople = function() {
      this.updatePartnerPositions();
      this.drawRelationLines();
      this.updateChildrenPositions();
      this.drawHorizontalLineBetweenChildren();
      return this.drawRelationTopVerticalLine();
    };

    PersonNode.prototype.updateTopPeople = function(align) {
      var y;
      if (align == null) {
        align = 'center';
      }
      if (this.person.parentRelation) {
        y = this.y - Constants.verticalMargin - Constants.height / 2;
        this.updateSiblingsPositions(align);
        this.updateParentsPosition(y, align);
        this.drawParentsHLine(y);
        this.updateParentsVLinePosition();
        return this.drawSiblingsHLine(y);
      }
    };

    PersonNode.prototype.updatePartnerPositions = function() {
      var distance, i, offset, partnerRelation, _i, _len, _ref, _results;
      distance = 0;
      _ref = this.person.partnerRelations;
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        partnerRelation = _ref[i];
        if (i === 0) {
          offset = Constants.width + Constants.margin;
          if (this.person.sex === 'M') {
            _results.push(partnerRelation.wife.node.setPosition(this.x + offset, this.y));
          } else if (this.person.sex === 'F') {
            _results.push(partnerRelation.husband.node.setPosition(this.x - offset, this.y));
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    PersonNode.prototype.drawRelationLines = function() {
      var husbandsX, maxX, minX, partnerRelation, wivesX, _i, _len, _ref, _results;
      if (this.person.partnerRelations.length) {
        husbandsX = _.collect([this.person.partnerRelations[0]], function(p) {
          return p.husband.node.x;
        });
        wivesX = _.collect([this.person.partnerRelations[0]], function(p) {
          return p.wife.node.x;
        });
        minX = _.min(husbandsX.concat(wivesX), function(value) {
          return value;
        });
        maxX = _.max(husbandsX.concat(wivesX), function(value) {
          return value;
        });
        _ref = this.person.partnerRelations;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          partnerRelation = _ref[_i];
          partnerRelation.node.setHLine(minX, maxX, this.y);
          _results.push(partnerRelation.node.drawHLine());
        }
        return _results;
      }
    };

    PersonNode.prototype.updateChildrenPositions = function() {
      var child, children, childrenSize, husband, i, offset, partnerRelation, start, wife, _i, _len, _results;
      if (this.person.partnerRelations.length) {
        partnerRelation = this.person.partnerRelations[0];
        husband = partnerRelation.husband;
        wife = partnerRelation.wife;
        children = partnerRelation.children;
        start = (husband.node.x + wife.node.x) / 2;
        if (children.length === 1) {
          start = start + Constants.width / 2 + Constants.margin / 2;
        }
        childrenSize = partnerRelation.node.globalWidth();
        start = start - childrenSize / 2 + Constants.width / 2;
        _results = [];
        for (i = _i = 0, _len = children.length; _i < _len; i = ++_i) {
          child = children[i];
          offset = child.node.x - child.node.leftMostNodeX();
          child.node.setPosition(start + offset, this.y + Constants.height / 2 + Constants.verticalMargin);
          child.node.updateBottomPeople();
          if (child.partnerRelations.length) {
            _results.push(start = start + child.partnerRelations[0].node.globalWidth() + Constants.margin);
          } else {
            _results.push(start = start + Constants.width + Constants.margin);
          }
        }
        return _results;
      }
    };

    PersonNode.prototype.drawHorizontalLineBetweenChildren = function() {
      var children, i, partnerRelation, _i, _len, _ref, _results;
      _ref = this.person.partnerRelations;
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        partnerRelation = _ref[i];
        if (i === 0) {
          children = partnerRelation.children;
          if (children.length > 1) {
            partnerRelation.node.childrenHLineStartX = children[0].node.x;
            partnerRelation.node.childrenHLineEndX = _.last(children).node.x;
            partnerRelation.node.childrenHLineY = this.y + Constants.verticalMargin / 2;
            _results.push(partnerRelation.node.drawChildrenHLine());
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    PersonNode.prototype.drawRelationTopVerticalLine = function() {
      var children, endX, i, partnerRelation, startX, _i, _len, _ref, _results;
      _ref = this.person.partnerRelations;
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        partnerRelation = _ref[i];
        if (i === 0) {
          children = partnerRelation.children;
          if (children.length) {
            startX = partnerRelation.husband.node.x;
            endX = partnerRelation.wife.node.x;
            partnerRelation.node.vLine.position.x = (startX + endX) / 2;
            _results.push(partnerRelation.node.vLine.position.y = this.y + Constants.verticalMargin / 4);
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    PersonNode.prototype.updateSiblingsPositions = function(align) {
      var child, children, childrenLeftDistance, childrenRightDistance, i, leftDistance, offset, personIndex, rightDistance, startIndex, _i, _j, _k, _len, _ref, _results;
      if (align == null) {
        align = 'center';
      }
      children = this.person.parentRelation.children;
      personIndex = _.findIndex(children, this.person);
      for (i = _i = 0, _len = children.length; _i < _len; i = ++_i) {
        child = children[i];
        if (i !== personIndex) {
          child.node.setPosition(this.x - 1000, this.y, false);
          child.node.updateBottomPeople();
        }
      }
      if (align === 'center' || align === 'left') {
        leftDistance = this.x - this.leftMostNodeX() + Constants.width / 2;
        offset = 0;
        startIndex = align === 'center' ? personIndex : children.length - 1;
        for (i = _j = startIndex; startIndex <= 0 ? _j <= 0 : _j >= 0; i = startIndex <= 0 ? ++_j : --_j) {
          if (i !== personIndex) {
            child = children[i];
            childrenRightDistance = child.node.rightMostNodeX() - child.node.x + Constants.width / 2;
            child.node.setPosition(this.x - (leftDistance + childrenRightDistance + Constants.margin + offset), this.y);
            child.node.updateBottomPeople();
            offset = offset + child.node.size() + Constants.margin;
          }
        }
      }
      if (align === 'center' || align === 'right') {
        rightDistance = this.rightMostNodeX() - this.x + Constants.width / 2;
        offset = 0;
        startIndex = align === 'center' ? personIndex : 0;
        _results = [];
        for (i = _k = startIndex, _ref = children.length - 1; startIndex <= _ref ? _k <= _ref : _k >= _ref; i = startIndex <= _ref ? ++_k : --_k) {
          if (i !== personIndex) {
            child = children[i];
            childrenLeftDistance = child.node.x - child.node.leftMostNodeX() + Constants.width / 2;
            child.node.setPosition(this.x + (rightDistance + childrenLeftDistance + Constants.margin + offset), this.y);
            child.node.updateBottomPeople();
            _results.push(offset = offset + child.node.size() + Constants.margin);
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      }
    };

    PersonNode.prototype.updateParentsPosition = function(y, align) {
      var father, left, limitLeft, limitRight, mother, offset, parentsCenter, parentsSize, right, v, w;
      if (align == null) {
        align = 'center';
      }
      father = this.person.parentRelation.husband;
      mother = this.person.parentRelation.wife;
      if (this.person.siblings().length === 0) {
        parentsCenter = this.x;
      } else {
        right = mother.node.rightMostNodeX();
        left = father.node.leftMostNodeX();
        parentsCenter = left + (right - left) / 2;
      }
      if (align === 'left' || align === 'right') {
        father.node.setPosition(this.x - Constants.margin / 2, this.y);
        mother.node.setPosition(this.x + Constants.margin / 2, this.y);
        if (father.parentRelation && mother.parentRelation) {
          father.node.updateTopPeople('left');
          mother.node.updateTopPeople('right');
        } else {
          father.node.updateTopPeople('center');
          mother.node.updateTopPeople('center');
        }
        limitLeft = this.leftMostParentNodeX() - Constants.width / 2;
        limitRight = this.rightMostParentNodeX() + Constants.width / 2;
        parentsSize = limitRight - limitLeft;
        if (align === 'left') {
          v = limitRight - parentsCenter;
          w = this.x - parentsCenter + Constants.width / 2;
          offset = Math.abs(v - w) > 1 ? v - w : 0;
          parentsCenter = Math.min(this.x + Constants.width / 2 - parentsSize / 2 - offset / 2, parentsCenter);
        } else if (align === 'right') {
          v = parentsCenter - limitLeft;
          w = parentsCenter - this.x - Constants.width / 2;
          offset = Math.abs(w - v) > 1 ? v - w : 0;
          parentsCenter = Math.max(this.x - Constants.width / 2 + parentsSize / 2 + offset / 2, parentsCenter);
        }
      }
      father.node.setPosition(parentsCenter - Constants.margin / 2 - Constants.width / 2, y);
      mother.node.setPosition(parentsCenter + Constants.margin / 2 + Constants.width / 2, y);
      if (father.parentRelation && mother.parentRelation) {
        father.node.updateTopPeople('left');
        return mother.node.updateTopPeople('right');
      } else {
        father.node.updateTopPeople('center');
        return mother.node.updateTopPeople('center');
      }
    };

    PersonNode.prototype.drawParentsHLine = function(y) {
      var husband, parentRelationNode, wife;
      parentRelationNode = this.person.parentRelation.node;
      husband = this.person.parentRelation.husband;
      wife = this.person.parentRelation.wife;
      parentRelationNode.hLineStartX = husband.node.x + Constants.width / 2;
      parentRelationNode.hLineEndX = wife.node.x - Constants.width / 2;
      parentRelationNode.hLineY = y;
      return parentRelationNode.drawHLine();
    };

    PersonNode.prototype.updateParentsVLinePosition = function() {
      var husband, parentRelationNode, wife;
      husband = this.person.parentRelation.husband;
      wife = this.person.parentRelation.wife;
      parentRelationNode = this.person.parentRelation.node;
      parentRelationNode.vLine.position.x = (husband.node.x + wife.node.x) / 2;
      return parentRelationNode.vLine.position.y = husband.node.y + Constants.verticalMargin / 4;
    };

    PersonNode.prototype.drawSiblingsHLine = function(y) {
      var children, parentRelationNode;
      parentRelationNode = this.person.parentRelation.node;
      children = this.person.parentRelation.children;
      parentRelationNode.childrenHLineY = y + Constants.verticalMargin / 2;
      parentRelationNode.childrenHLineStartX = _.min(children, function(child) {
        return child.node.x;
      }).node.x;
      parentRelationNode.childrenHLineEndX = _.max(children, function(child) {
        return child.node.x;
      }).node.x;
      if (this.person.sex === 'F') {
        parentRelationNode.childrenHLineEndX = Math.max(parentRelationNode.childrenHLineEndX, parentRelationNode.vLine.position.x);
      } else if (this.person.sex === 'M') {
        parentRelationNode.childrenHLineStartX = Math.min(parentRelationNode.childrenHLineStartX, parentRelationNode.vLine.position.x);
      }
      return parentRelationNode.drawChildrenHLine();
    };

    return PersonNode;

  })();

  this.Relation = (function() {
    function Relation(uuid) {
      if (uuid == null) {
        uuid = void 0;
      }
      this.husband = void 0;
      this.wife = void 0;
      this.children = [];
      this.uuid = uuid ? uuid : window.uuid();
    }

    Relation.prototype.addChild = function(name, sex) {
      var child;
      child = new Person(name, sex);
      child.parentRelation = this;
      this.children.push(child);
      return child;
    };

    return Relation;

  })();

  this.RelationNode = (function() {
    function RelationNode(stage, relation) {
      this.stage = stage;
      this.relation = relation;
      this.relation.node = this;
      this.initializeLines();
    }

    RelationNode.prototype.initializeLines = function() {
      this.initializeHLine();
      this.initializeVLine();
      return this.initializeChildrenHLine();
    };

    RelationNode.prototype.initializeHLine = function() {
      this.hLineStartX = 0;
      this.hLineEndX = 0;
      this.hLineY = 0;
      this.hLine = new PIXI.Graphics();
      return this.stage.addChild(this.hLine);
    };

    RelationNode.prototype.initializeChildrenHLine = function() {
      this.childrenHLineStartX = 0;
      this.childrenHLineEndX = 0;
      this.childrenHLineY = 0;
      this.childrenHLine = new PIXI.Graphics();
      return this.stage.addChild(this.childrenHLine);
    };

    RelationNode.prototype.initializeVLine = function() {
      this.vLine = new PIXI.Graphics();
      this.vLine.lineStyle(Constants.lineWidth, 0x333333, 1);
      this.vLine.moveTo(0, -Constants.verticalMargin / 4);
      this.vLine.lineTo(0, Constants.verticalMargin / 4);
      return this.stage.addChild(this.vLine);
    };

    RelationNode.prototype.globalWidth = function() {
      return Math.max(this.relationWidth(), this.childrenWidth());
    };

    RelationNode.prototype.relationWidth = function() {
      return 2 * Constants.width + Constants.margin;
    };

    RelationNode.prototype.childrenWidth = function() {
      var child, partnerRelation, size, _i, _j, _len, _len1, _ref, _ref1;
      size = 0;
      _ref = this.relation.children;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        if (child.partnerRelations.length > 0) {
          size += Constants.width;
          _ref1 = child.partnerRelations;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            partnerRelation = _ref1[_j];
            size += partnerRelation.node.globalWidth() - Constants.width;
          }
        } else {
          size += Constants.width;
        }
        size += Constants.margin;
      }
      if (this.relation.children.length > 0) {
        size -= Constants.margin;
      }
      return size;
    };

    RelationNode.prototype.hideLines = function() {
      this.hLineStartX = 0;
      this.hLineEndX = 0;
      this.drawHLine();
      this.childrenHLineStartX = 0;
      this.childrenHLineEndX = 0;
      this.drawChildrenHLine();
      this.vLine.position.x = -1000;
      return this.vLine.position.y = -1000;
    };

    RelationNode.prototype.setHLine = function(startX, endX, y) {
      this.hLineStartX = startX;
      this.hLineEndX = endX;
      return this.hLineY = y;
    };

    RelationNode.prototype.drawHLine = function() {
      this.hLine.clear();
      this.hLine.lineStyle(Constants.lineWidth, 0x333333, 1);
      this.hLine.moveTo(this.hLineStartX, this.hLineY);
      this.hLine.lineTo(this.hLineEndX, this.hLineY);
      return false;
    };

    RelationNode.prototype.drawChildrenHLine = function() {
      this.childrenHLine.clear();
      this.childrenHLine.lineStyle(Constants.lineWidth, 0x333333, 1);
      this.childrenHLine.moveTo(this.childrenHLineStartX, this.childrenHLineY);
      this.childrenHLine.lineTo(this.childrenHLineEndX, this.childrenHLineY);
      return false;
    };

    return RelationNode;

  })();

  $(function() {
    var abraham, bart, clancy, fatherOfLing, herb, homer, jackie, ling, lisa, maggie, marge, mona, patty, selma, _ref, _ref1;
    homer = new Person('Homer', 'M');
    marge = homer.addPartner('Marge');
    bart = homer.relationWith(marge).addChild('Bart', 'M');
    lisa = homer.relationWith(marge).addChild('Lisa', 'F');
    maggie = homer.relationWith(marge).addChild('Maggie', 'F');
    _ref = homer.addParents('Abraham', 'Mona'), abraham = _ref[0], mona = _ref[1];
    _ref1 = marge.addParents('Clancy', 'Jackie'), clancy = _ref1[0], jackie = _ref1[1];
    herb = abraham.relationWith(mona).addChild('Herb', 'M');
    patty = clancy.relationWith(jackie).addChild('Patty', 'F');
    selma = clancy.relationWith(jackie).addChild('Selma', 'F');
    fatherOfLing = selma.addPartner('Father of Ling');
    return ling = selma.relationWith(fatherOfLing).addChild('Ling', 'F');
  });

  window.uuid = function() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r, v;
      r = Math.random() * 16 | 0;
      v = c === 'x' ? r : r & 0x3 | 0x8;
      return v.toString(16);
    });
  };

}).call(this);
