// Generated by CoffeeScript 1.6.3
(function() {
  var Person, PersonNode, Relation, RelationNode;

  $(function() {
    var animate, homer, homerMargeNode, homerNode, homerSelmaNode, marge, margeNode, renderer, rootNode, selma, selmaNode, stage;
    renderer = new PIXI.autoDetectRenderer(1024, 768, {
      antialias: true,
      backgroundColor: 0xFFFFFF
    });
    $('#content')[0].appendChild(renderer.view);
    stage = new PIXI.Container();
    homer = new Person('Homer', 'M');
    marge = homer.addPartner('Marge Bouvier');
    selma = homer.addPartner('Selma Bouvier');
    homerNode = new PersonNode(stage, homer);
    margeNode = new PersonNode(stage, marge);
    selmaNode = new PersonNode(stage, selma);
    homerMargeNode = new RelationNode(stage, homer.relationWith(marge));
    homerSelmaNode = new RelationNode(stage, homer.relationWith(selma));
    rootNode = homerNode;
    rootNode.displayTree(400, 384);
    animate = function() {
      requestAnimationFrame(animate);
      rootNode.update();
      return renderer.render(stage);
    };
    return animate();
  });

  Person = (function() {
    function Person(name, sex) {
      this.name = name;
      this.sex = sex;
      this.parentRelation = void 0;
      this.partnerRelations = [];
    }

    Person.prototype.partners = function() {
      var _this = this;
      return _.collect(this.partnerRelations, function(relation) {
        return relation[_this.sex === 'M' ? 'wife' : 'husband'];
      });
    };

    Person.prototype.children = function() {
      return _.flatten(_.collect(this.partnerRelations, function(partnerRelation) {
        return partnerRelation.children;
      }));
    };

    Person.prototype.mother = function() {
      if (this.parentRelation) {
        return this.parentRelation.wife;
      }
    };

    Person.prototype.father = function() {
      if (this.parentRelation) {
        return this.parentRelation.husband;
      }
    };

    Person.prototype.parents = function() {
      return _.compact([this.father(), this.mother()]);
    };

    Person.prototype.grandparents = function() {
      return this.father().parents().concat(this.mother().parents());
    };

    Person.prototype.siblings = function() {
      return _.difference(this.parentRelation.children, [this]);
    };

    Person.prototype.niblings = function() {
      return _.flatten(_.collect(this.siblings(), function(sibling) {
        return sibling.children();
      }));
    };

    Person.prototype.parentsSiblings = function() {
      return this.father().siblings().concat(this.mother().siblings());
    };

    Person.prototype.cousins = function() {
      return _.flatten(_.collect(this.parentsSiblings(), function(sibling) {
        return sibling.children();
      }));
    };

    Person.prototype.relationWith = function(person) {
      var _this = this;
      return _.find(this.partnerRelations, function(relation) {
        return (_this.sex === 'M' && relation.wife === person) || (_this.sex === 'F' && relation.husband === person);
      });
    };

    Person.prototype.addParents = function(fatherName, motherName) {
      if (fatherName == null) {
        fatherName = void 0;
      }
      if (motherName == null) {
        motherName = void 0;
      }
      fatherName = fatherName ? fatherName : "Father of " + this.name;
      motherName = motherName ? motherName : "Mother of " + this.name;
      this.parentRelation = new Relation();
      this.parentRelation.children.push(this);
      this.parentRelation.husband = new Person(fatherName, 'M');
      this.parentRelation.wife = new Person(motherName, 'F');
      this.parentRelation.husband.partnerRelations.push(this.parentRelation);
      this.parentRelation.wife.partnerRelations.push(this.parentRelation);
      return [this.parentRelation.husband, this.parentRelation.wife];
    };

    Person.prototype.addPartner = function(name) {
      var husbandName, relation, wifeName;
      if (name == null) {
        name = void 0;
      }
      relation = new Relation();
      if (this.sex === 'M') {
        relation.husband = this;
        wifeName = name ? name : "Wife of " + this.name;
        relation.wife = new Person(wifeName, 'F');
        relation.wife.partnerRelations.push(relation);
        this.partnerRelations.push(relation);
        return relation.wife;
      } else {
        relation.wife = this;
        husbandName = name ? name : "Husband of " + this.name;
        relation.husband = new Person(husbandName, 'M');
        relation.husband.partnerRelations.push(relation);
        this.partnerRelations.push(relation);
        return relation.husband;
      }
    };

    return Person;

  })();

  PersonNode = (function() {
    var FONT_SIZE, HEIGHT, LINE_WIDTH, MARGIN, PADDING;

    HEIGHT = 40;

    FONT_SIZE = 15;

    PADDING = 20;

    MARGIN = 40;

    LINE_WIDTH = 2;

    function PersonNode(stage, person) {
      this.stage = stage;
      this.person = person;
      this.root = false;
      this.dirty_root = false;
      this.dirty_position = true;
      this.dirty_iterator = 0;
      this.person.node = this;
      this.initializeRectangle();
      this.initializeText();
    }

    PersonNode.prototype.initializeRectangle = function() {
      var color;
      color = this.person.sex === 'M' ? 0xB4D8E7 : 0xFFC0CB;
      this.graphics = new PIXI.Graphics();
      this.graphics.lineStyle(LINE_WIDTH, 0x333333, 1);
      this.graphics.beginFill(color);
      if (this.person.sex === 'M') {
        this.graphics.drawRect(0, 0, 200, HEIGHT);
      } else {
        this.graphics.drawRoundedRect(0, 0, 200, HEIGHT, HEIGHT / 5);
      }
      this.graphics.position.x = -1000;
      this.graphics.position.y = -1000;
      return this.stage.addChild(this.graphics);
    };

    PersonNode.prototype.initializeText = function() {
      this.text = new PIXI.Text(this.person.name, {
        font: "" + FONT_SIZE + "px Arial",
        fill: 0x222222
      });
      this.text.position.x = -1000;
      this.text.position.y = -1000;
      this.text.anchor.x = 0.5;
      return this.stage.addChild(this.text);
    };

    PersonNode.prototype.displayTree = function(x, y) {
      this.root = true;
      this.dirty_root = true;
      this.dirty_iterator = 0;
      return this.setPosition(x, y);
    };

    PersonNode.prototype.width = function() {
      return this.graphics.width;
    };

    PersonNode.prototype.position = function() {
      return this.text.position;
    };

    PersonNode.prototype.setPosition = function(x, y) {
      this.text.position.x = x;
      this.text.position.y = y;
      return this.dirty_position = true;
    };

    PersonNode.prototype.update = function() {
      var distance, endX, endY, lastBoxWidth, partner, partnerRelation, startX, startY, _i, _j, _len, _len1, _ref, _ref1;
      if (this.dirty_position) {
        this.graphics.width = this.text.width + PADDING;
        this.graphics.position.x = this.text.position.x - this.text.width / 2 - PADDING / 2;
        this.graphics.position.y = this.text.position.y - this.text.height + 6;
        this.dirty_position = false;
      }
      if (this.dirty_root) {
        distance = 0;
        lastBoxWidth = this.width();
        _ref = this.person.partners();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          partner = _ref[_i];
          if (this.person.sex === 'M') {
            distance = distance + MARGIN + lastBoxWidth / 2 + partner.node.width() / 2;
          } else {
            distance = distance - MARGIN - lastBoxWidth / 2 - partner.node.width() / 2;
          }
          lastBoxWidth = partner.node.width();
          partner.node.setPosition(this.text.position.x + distance, this.text.position.y);
          partner.node.update();
        }
        startY = endY = this.graphics.position.y + HEIGHT / 2;
        distance = -MARGIN - this.width() / 2;
        lastBoxWidth = this.width();
        _ref1 = this.person.partnerRelations;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          partnerRelation = _ref1[_j];
          distance = distance + lastBoxWidth + MARGIN;
          if (this.person.sex === 'M') {
            lastBoxWidth = partnerRelation.wife.node.width();
            startX = this.text.position.x + distance - LINE_WIDTH / 2;
            endX = this.text.position.x + distance + MARGIN;
          } else {
            lastBoxWidth = partnerRelation.husband.node.width();
            startX = this.text.position.x - distance + LINE_WIDTH / 2;
            endX = this.text.position.x - distance - MARGIN;
          }
          partnerRelation.node.drawLine({
            x: startX,
            y: startY
          }, {
            x: endX,
            y: endY
          });
        }
        if (this.dirty_iterator === 5) {
          this.dirty_root = false;
        }
        return this.dirty_iterator++;
      }
    };

    return PersonNode;

  })();

  Relation = (function() {
    function Relation() {
      this.husband = void 0;
      this.wife = void 0;
      this.children = [];
    }

    Relation.prototype.addChild = function(name, sex) {
      var child;
      child = new Person(name, sex);
      child.parentRelation = this;
      this.children.push(child);
      return child;
    };

    return Relation;

  })();

  RelationNode = (function() {
    var LINE_WIDTH;

    LINE_WIDTH = 2;

    function RelationNode(stage, relation) {
      this.stage = stage;
      this.relation = relation;
      this.dirty = true;
      this.relation.node = this;
      this.initializeLine();
    }

    RelationNode.prototype.initializeLine = function() {
      this.graphics = new PIXI.Graphics();
      return this.stage.addChild(this.graphics);
    };

    RelationNode.prototype.globalWidth = function() {
      var size;
      size = 0;
      size += this.relation.husband.node.width();
      size += this.relation.wife.node.width();
      size += this.relation.husband.node.MARGIN;
      return size += size;
    };

    RelationNode.prototype.drawLine = function(from, to) {
      this.graphics.clear;
      this.graphics.lineStyle(LINE_WIDTH, 0x333333, 1);
      this.graphics.moveTo(from.x, from.y);
      this.graphics.lineTo(to.x, to.y);
      return false;
    };

    return RelationNode;

  })();

  $(function() {
    var abraham, bart, clancy, fatherOfLing, herb, homer, jackie, ling, lisa, maggie, marge, mona, patty, selma, _ref, _ref1;
    homer = new Person('Homer', 'M');
    marge = homer.addPartner('Marge');
    bart = homer.relationWith(marge).addChild('Bart', 'M');
    lisa = homer.relationWith(marge).addChild('Lisa', 'F');
    maggie = homer.relationWith(marge).addChild('Maggie', 'F');
    _ref = homer.addParents('Abraham', 'Mona'), abraham = _ref[0], mona = _ref[1];
    _ref1 = marge.addParents('Clancy', 'Jackie'), clancy = _ref1[0], jackie = _ref1[1];
    herb = abraham.relationWith(mona).addChild('Herb', 'M');
    patty = clancy.relationWith(jackie).addChild('Patty', 'F');
    selma = clancy.relationWith(jackie).addChild('Selma', 'F');
    fatherOfLing = selma.addPartner('Father of Ling');
    return ling = selma.relationWith(fatherOfLing).addChild('Ling', 'F');
  });

}).call(this);
